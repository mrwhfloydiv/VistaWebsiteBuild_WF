---
const navItems = [
  { href: "/", label: "Home", accent: "#b22c2e" },
  { href: "/teams", label: "Teams", accent: "#ebaa1f" },
  { href: "/about", label: "About", accent: "#b5d9ee" },
  { href: "/insights", label: "Insights", accent: "#4a94ff" },
  { href: "/case-studies", label: "Case Studies", accent: "#b22c2e" },
  { href: "/contact", label: "Contact", accent: "#ebaa1f" }
];

const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL;
const basePath = base.endsWith("/") ? base.slice(0, -1) : base;
const normalizePath = (path) => (path.replace(/\/$/, "") || "/");
const currentNormalized = normalizePath(
  currentPath.startsWith(basePath) ? currentPath.slice(basePath.length) : currentPath
);
const baseWithSlash = base.endsWith("/") ? base : `${base}/`;
const withBase = (path) => `${baseWithSlash}${path.startsWith("/") ? path.slice(1) : path}`;
---

<header id="siteHeader" class="site-header sticky top-0 z-50">
  <div class="section-shell flex h-14 items-center justify-between gap-3 md:h-18">
    <a href={withBase("/")} class="flex items-center gap-3 font-semibold tracking-tight">
      <img
        src={withBase("/logos/simplified-white-text-red-arrow.png")}
        alt="Vista Site Selection"
        class="h-4 w-auto object-contain"
      />
    </a>

    <!-- Desktop nav (hidden on mobile) -->
    <nav aria-label="Main navigation" class="header-nav-scroll header-nav--desktop">
      <ul class="flex items-center gap-1 text-sm md:gap-2">
        {
          navItems.map((item) => (
            <li>
              <a
                href={withBase(item.href)}
                class={`header-nav-link ${
                  currentNormalized === normalizePath(item.href)
                    ? "header-nav-link--active"
                    : ""
                }`}
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>
    </nav>

    <!-- Mobile hamburger button (hidden on desktop) -->
    <button
      id="mobileMenuBtn"
      class="mobile-menu-btn"
      type="button"
      aria-label="Open navigation menu"
      aria-expanded="false"
    >
      <span class="mobile-menu-btn__line"></span>
      <span class="mobile-menu-btn__line"></span>
      <span class="mobile-menu-btn__line"></span>
    </button>
  </div>

  <!-- Mobile push-down menu â€” pushes content below it -->
  <div id="mobileDrawer" class="mobile-drawer" aria-hidden="true">
    <nav aria-label="Mobile navigation" class="mobile-drawer__nav">
      {
        navItems.map((item, i) => (
          <a
            href={withBase(item.href)}
            class={`mobile-drawer__link ${
              currentNormalized === normalizePath(item.href)
                ? "mobile-drawer__link--active"
                : ""
            }`}
            data-accent={item.accent}
            style={`--link-accent: ${item.accent}; --link-index: ${i};`}
          >
            <span class="mobile-drawer__link-num">{String(i + 1).padStart(2, "0")}</span>
            <span class="mobile-drawer__link-text">{item.label}</span>
          </a>
        ))
      }
    </nav>
  </div>
</header>

<script>
  const syncHeaderState = () => {
    const header = document.getElementById("siteHeader");
    if (!header) return;
    header.classList.toggle("is-scrolled", window.scrollY > 40);
  };

  syncHeaderState();
  window.addEventListener("scroll", syncHeaderState, { passive: true });
  document.addEventListener("astro:page-load", syncHeaderState);

  // Mobile drawer toggle
  const menuBtn = document.getElementById("mobileMenuBtn");
  const drawer = document.getElementById("mobileDrawer");
  if (menuBtn && drawer) {
    const links = Array.from(drawer.querySelectorAll<HTMLAnchorElement>(".mobile-drawer__link"));

    const toggleDrawer = (open?: boolean) => {
      const shouldOpen = open ?? !drawer.classList.contains("is-open");
      drawer.classList.toggle("is-open", shouldOpen);
      menuBtn.classList.toggle("is-open", shouldOpen);
      menuBtn.setAttribute("aria-expanded", String(shouldOpen));
      drawer.setAttribute("aria-hidden", String(!shouldOpen));

      // Staggered entrance animation
      if (shouldOpen) {
        links.forEach((link, i) => {
          link.style.transitionDelay = `${0.04 * i}s`;
          link.classList.add("is-entering");
        });
        // Remove the class after animation completes so hover transitions work normally
        setTimeout(() => {
          links.forEach(link => {
            link.style.transitionDelay = "0s";
            link.classList.remove("is-entering");
          });
        }, 400);
      } else {
        links.forEach(link => {
          link.style.transitionDelay = "0s";
          link.classList.remove("is-entering");
        });
      }
    };

    menuBtn.addEventListener("click", () => toggleDrawer());

    // Close on link click
    links.forEach(link => {
      link.addEventListener("click", () => toggleDrawer(false));
    });

    // Close on ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && drawer.classList.contains("is-open")) {
        toggleDrawer(false);
      }
    });

    // Close when scrolling past a threshold
    let lastScrollY = window.scrollY;
    window.addEventListener("scroll", () => {
      if (drawer.classList.contains("is-open") && Math.abs(window.scrollY - lastScrollY) > 100) {
        toggleDrawer(false);
      }
      lastScrollY = window.scrollY;
    }, { passive: true });
  }
</script>
