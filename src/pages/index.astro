---
import Layout from "../layouts/Layout.astro";
import { teamBuckets } from "../data/teams";

const base = import.meta.env.BASE_URL;
const baseWithSlash = base.endsWith("/") ? base : `${base}/`;
const withBase = (path) => `${baseWithSlash}${path.startsWith("/") ? path.slice(1) : path}`;

const heroSlides = [
  {
    title: "Decisions with weight.\nDelivery with speed.",
    isHero: true,
  },
  {
    title: "Signal in\nthe noise.",
  },
  {
    title: "Leverage in\nevery market.",
  },
  {
    title: "Execution that\nholds up.",
  },
];

const orbitNodeMap = [
  { slug: "economic-impact-studies",  id: "node-eis",         ring: 1 },
  { slug: "aerospace-defense",       id: "node-aerospace",   ring: 2 },
  { slug: "data-analytics",          id: "node-data",        ring: 2 },
  { slug: "data-centers",            id: "node-datacenters", ring: 2 },
  { slug: "incentives-compliance",   id: "node-incentives",  ring: 1 },
  { slug: "leadership",              id: "node-leadership",  ring: 1 },
];

const orbitNodes = orbitNodeMap.map(({ slug, id, ring }) => {
  const team = teamBuckets.find(t => t.slug === slug)!;
  return {
    id,
    ring,
    label: team.name,
    shortName: team.shortName,
    accent: team.accent,
    description: team.summary.split(".")[0] + ".",
    href: `/teams/${slug}`,
  };
}).concat([{
  id: "node-contact",
  ring: 3,
  label: "Start a Conversation",
  shortName: "COMMS",
  accent: "#b5d9ee",
  description: "Reach the Vista team directly.",
  href: "/contact",
}]);

const homeMotionConfig = {
  sequenceHeightDesktop: 620,
  sequenceHeightMobile: 560,
  animation: {
    revealDuration: 0.8,
    revealY: 24,
    magneticScale: 1.02
  },
  stars: {
    desktopCount: 920,
    mobileCount: 520,
    depth: 1600,
    baseSpeed: 0.28,
    warpBoost: 5.2
  },
  orbit: {
    start: 0.76,
    full: 0.93,
    radiusDesktop: 560,
    radiusMobile: 280,
    rings: [
      { radiusFactor: 0.45, ellipseRatio: 0.52, ellipseRatioMobile: 0.60, speedMultiplier: 1.4, tiltOffset: 0, strokeAlpha: 0.10 },
      { radiusFactor: 0.72, ellipseRatio: 0.58, ellipseRatioMobile: 0.66, speedMultiplier: 1.0, tiltOffset: 0.08, strokeAlpha: 0.14 },
      { radiusFactor: 1.0, ellipseRatio: 0.64, ellipseRatioMobile: 0.72, speedMultiplier: 0.7, tiltOffset: -0.06, strokeAlpha: 0.18 },
    ]
  }
};
---

<Layout
  title="Vista Site Selection | Reimagined"
  description="Responsive, motion-forward concept for Vista Site Selection featuring immersive storytelling and bucketed specialty teams."
>
  <section id="heroSequenceWrapper" class="hero-sequence-wrapper" data-motion-config={JSON.stringify(homeMotionConfig)} data-logo-src={withBase("/logos/vista-mark-white.png")} data-base-path={baseWithSlash.replace(/\/$/, "")}>
    <div class="hero-sequence-sticky">
      <canvas id="heroWaveCanvas" class="hero-wave-canvas" aria-hidden="true"></canvas>
      <div class="hero-noise-layer"></div>
      <div class="hero-scanline-layer" aria-hidden="true"></div>

      <div class="section-shell hero-overlay-grid hero-overlay-grid--solo">
        <div id="heroIntro" class="hero-stack">
          <span class="chip chip--ghost">Site Selection + Incentives + Analytics</span>

          <!-- Title fly-through zone — all 4 titles live here -->
          <div id="heroSlideTrack" class="hero-slide-track-inline">
            <div class="hero-slide-frame">
              {
                heroSlides.map((slide, index) => (
                  <article
                    class={`hero-slide ${index === 0 ? "is-active" : ""}`}
                    data-slide
                    data-hero={slide.isHero ? "true" : undefined}
                  >
                    <h2 class="hero-title">
                      {slide.title.split("\n").map((line, lineIndex, lines) => (
                        <>
                          {slide.isHero && lineIndex === 0 ? (
                            <Fragment>Decisions with <span class="text-[#ebaa1f]">weight</span>.</Fragment>
                          ) : slide.isHero && lineIndex === 1 ? (
                            <Fragment>Delivery with <span class="text-[#b5d9ee]">speed</span>.</Fragment>
                          ) : (
                            <Fragment>{line}</Fragment>
                          )}
                          {lineIndex < lines.length - 1 && <br />}
                        </>
                      ))}
                    </h2>
                  </article>
                ))
              }
            </div>
          </div>

          <p class="max-w-2xl text-lg text-white/80 md:text-xl">
            Vista helps organizations pick the right locations, secure stronger incentives, and move with confidence
            using data-backed strategy.
          </p>
          <div class="flex flex-wrap gap-3">
            <a class="btn-primary magnetic-btn" href={withBase("/contact")}>Start a conversation</a>
            <a class="btn-secondary magnetic-btn btn-explore" href={withBase("/teams")}>Explore team buckets</a>
            <button id="skipIntroBtn" class="btn-secondary hero-skip-btn btn-skip magnetic-btn" type="button">
              Skip to orbit menu
            </button>
          </div>
          <div class="hero-kicker-list">
            <span class="mono">Board-ready strategy</span>
            <span class="mono">Negotiation leverage</span>
            <span class="mono">Execution certainty</span>
          </div>
        </div>
      </div>

      <div id="heroScrollCue" class="scroll-down-indicator scroll-down-indicator--hero" aria-hidden="true">
        <span class="scroll-down-indicator__text">Scroll to explore</span>
        <svg class="scroll-down-indicator__chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>

      <div id="orbitMenu" class="orbit-menu" aria-hidden="true">
        <div class="orbit-core">
          <canvas id="orbitPlanetCanvas" class="orbit-planet-canvas" aria-hidden="true"></canvas>
        </div>
        {
          orbitNodes.map((node, index) => (
            <a
              id={node.id}
              href={withBase(node.href)}
              class="orbit-node"
              data-orbit-node
              data-orbit-index={index}
              data-ring={node.ring}
              data-accent={node.accent}
              data-desc={node.description}
              data-short={node.shortName}
              aria-label={node.label}
            >
              <span class="orbit-node__dot"></span>
              <span class="orbit-node__pulse"></span>
              <span class="orbit-node__name">{node.shortName}</span>
              <div class="orbit-node__popup">
                <span class="orbit-node__popup-corner"></span>
                <span class="orbit-node__label">{node.label}</span>
                <span class="orbit-node__desc">{node.description}</span>
              </div>
            </a>
          ))
        }
      </div>

      <div id="scrollDownIndicator" class="scroll-down-indicator" aria-hidden="true">
        <span class="scroll-down-indicator__text">Keep exploring</span>
        <svg class="scroll-down-indicator__chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>

      <div id="mobilePopupOverlay" class="mobile-popup-overlay" aria-hidden="true">
        <div class="mobile-popup-overlay__card">
          <span class="mobile-popup-overlay__label"></span>
          <span class="mobile-popup-overlay__desc"></span>
          <span class="mobile-popup-overlay__cta">Tap again to visit &rarr;</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ── 1. METRIC COUNTERS ── -->
  <section class="metric-section" id="metricSection">
    <div class="section-shell">
      <div class="metric-header" data-reveal>
        <span class="chip">By the Numbers</span>
        <h2 class="text-3xl md:text-4xl">The weight behind<br/>every recommendation.</h2>
        <p class="metric-header__sub">Numbers without context are noise. Here is what ours mean.</p>
      </div>

      <div class="metric-grid">
        <article class="metric-tile" data-accent="#ebaa1f" data-accent-light="true" data-metric-index="0">
          <div class="metric-tile__glow" aria-hidden="true"></div>
          <div class="metric-tile__icon" aria-hidden="true">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </div>
          <p class="stat-number text-[#ebaa1f]" data-counter data-target="1000" data-suffix="+">0</p>
          <p class="metric-tile__label mono">PROJECTS SUPPORTED</p>
          <p class="metric-tile__context">Across 40+ states, from Fortune 100 relocations to emerging-market expansions.</p>
        </article>

        <article class="metric-tile" data-accent="#b5d9ee" data-accent-light="true" data-metric-index="1">
          <div class="metric-tile__glow" aria-hidden="true"></div>
          <div class="metric-tile__icon" aria-hidden="true">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          </div>
          <p class="stat-number text-[#b5d9ee]" data-counter data-prefix="$" data-target="4" data-suffix="B+">0</p>
          <p class="metric-tile__label mono">INCENTIVES NEGOTIATED</p>
          <p class="metric-tile__context">Real dollars secured at the table — not projections, not estimates.</p>
        </article>

        <article class="metric-tile" data-accent="#fafafa" data-accent-light="true" data-metric-index="2">
          <div class="metric-tile__glow" aria-hidden="true"></div>
          <div class="metric-tile__icon" aria-hidden="true">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          </div>
          <p class="stat-number text-white" data-counter data-target="40" data-suffix="+">0</p>
          <p class="metric-tile__label mono">MARKETS ANALYZED YEARLY</p>
          <p class="metric-tile__context">Proprietary scoring across labor, cost, risk, and regulatory dimensions.</p>
        </article>

        <article class="metric-tile" data-accent="#b22c2e" data-metric-index="3">
          <div class="metric-tile__glow" aria-hidden="true"></div>
          <div class="metric-tile__icon" aria-hidden="true">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <p class="stat-number text-[#b22c2e]">24/7</p>
          <p class="metric-tile__label mono">EXECUTION MINDSET</p>
          <p class="metric-tile__context">Location decisions don't wait. Neither do we.</p>
        </article>
      </div>
    </div>
  </section>

  <!-- ── 2. PROCESS — STACKING CARDS ── -->
  <section class="process-section" id="processSection">
    <div class="section-shell">
      <div class="process-header">
        <span class="chip">Client Workflow</span>
        <h2 class="text-3xl md:text-5xl">How Vista runs<br/>engagements.</h2>
        <p class="process-header__sub">Four phases. One integrated team. Zero ambiguity.</p>
      </div>
    </div>

    <div class="process-stack" id="processStack">
      <article class="process-card" data-process-card="0" data-accent-light="true" style="--card-accent: #ebaa1f; --card-bg: #11100c;">
        <div class="process-card__scan" aria-hidden="true"></div>
        <div class="process-card__spot" aria-hidden="true"></div>
        <div class="process-card__inner">
          <div class="process-card__left">
            <span class="process-card__num">01</span>
            <div class="process-card__tag">WEEK 1–2</div>
          </div>
          <div class="process-card__body">
            <h3 class="process-card__title">Frame the Decision</h3>
            <p class="process-card__desc">Lock the strategic criteria and business constraints before a single market is scored. We align leadership, define non-negotiables, and build the analytical framework that drives every recommendation forward.</p>
          </div>
          <div class="process-card__icon" aria-hidden="true">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
          </div>
        </div>
        <div class="process-card__accent-line" aria-hidden="true"></div>
      </article>

      <article class="process-card" data-process-card="1" data-accent-light="true" style="--card-accent: #b5d9ee; --card-bg: #0c0f12;">
        <div class="process-card__scan" aria-hidden="true"></div>
        <div class="process-card__spot" aria-hidden="true"></div>
        <div class="process-card__inner">
          <div class="process-card__left">
            <span class="process-card__num">02</span>
            <div class="process-card__tag">WEEK 3–6</div>
          </div>
          <div class="process-card__body">
            <h3 class="process-card__title">Model the Markets</h3>
            <p class="process-card__desc">Score labor, cost, risk, and operational fit across every viable metro. Our proprietary models weigh 40+ variables to surface the sites that match strategy — not just availability.</p>
          </div>
          <div class="process-card__icon" aria-hidden="true">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </div>
        </div>
        <div class="process-card__accent-line" aria-hidden="true"></div>
      </article>

      <article class="process-card" data-process-card="2" data-accent-light="true" style="--card-accent: #fafafa; --card-bg: #0c0f12;">
        <div class="process-card__scan" aria-hidden="true"></div>
        <div class="process-card__spot" aria-hidden="true"></div>
        <div class="process-card__inner">
          <div class="process-card__left">
            <span class="process-card__num">03</span>
            <div class="process-card__tag">WEEK 6–10</div>
          </div>
          <div class="process-card__body">
            <h3 class="process-card__title">Shape the Incentives</h3>
            <p class="process-card__desc">Build and negotiate package structures with leverage no one else brings to the table. We know where the money is — and how to structure a deal that survives political cycles.</p>
          </div>
          <div class="process-card__icon" aria-hidden="true">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          </div>
        </div>
        <div class="process-card__accent-line" aria-hidden="true"></div>
      </article>

      <article class="process-card" data-process-card="3" style="--card-accent: #b22c2e; --card-bg: #110c0c;">
        <div class="process-card__scan" aria-hidden="true"></div>
        <div class="process-card__spot" aria-hidden="true"></div>
        <div class="process-card__inner">
          <div class="process-card__left">
            <span class="process-card__num">04</span>
            <div class="process-card__tag">WEEK 10+</div>
          </div>
          <div class="process-card__body">
            <h3 class="process-card__title">Execute Confidently</h3>
            <p class="process-card__desc">Move from selection to launch with implementation rigor that holds up under scrutiny. We stay in the room until the ribbon is cut — not just until the report is filed.</p>
          </div>
          <div class="process-card__icon" aria-hidden="true">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          </div>
        </div>
        <div class="process-card__accent-line" aria-hidden="true"></div>
      </article>
    </div>
  </section>

  <!-- ── 3. DIFFERENTIATORS ── -->
  <section class="diff-section-wrap" id="diffSection">
    <div class="section-shell py-24">
      <div class="diff-section">
        <div class="diff-header" data-reveal>
          <span class="chip">The Vista Edge</span>
          <h2 class="text-4xl md:text-5xl lg:text-6xl">Three reasons we<br/>don't lose.</h2>
          <p class="diff-header__sub">Every engagement starts with three structural advantages no competitor can replicate.</p>
        </div>

        <div class="diff-cards">
          <article class="diff-card" data-tilt data-diff-index="0" data-accent-light="true" style="--diff-accent: #ebaa1f;">
            <div class="diff-card__glow-border" aria-hidden="true"></div>
            <div class="diff-card__bg-gradient" aria-hidden="true"></div>
            <div class="diff-card__number" aria-hidden="true">01</div>
            <div class="diff-card__accent"></div>
            <h3 class="diff-card__title">We integrate from day one</h3>
            <p class="diff-card__text">Site strategy, incentives, and analytics operate as one team from the first call. No handoffs. No silos. One engine.</p>
            <div class="diff-card__line" aria-hidden="true"></div>
          </article>

          <article class="diff-card" data-tilt data-diff-index="1" data-accent-light="true" style="--diff-accent: #b5d9ee;">
            <div class="diff-card__glow-border" aria-hidden="true"></div>
            <div class="diff-card__bg-gradient" aria-hidden="true"></div>
            <div class="diff-card__number" aria-hidden="true">02</div>
            <div class="diff-card__accent"></div>
            <h3 class="diff-card__title">We model downside early</h3>
            <p class="diff-card__text">Every recommendation is pressure-tested against labor risk, regulatory shifts, and governance alignment before it reaches your board.</p>
            <div class="diff-card__line" aria-hidden="true"></div>
          </article>

          <article class="diff-card" data-tilt data-diff-index="2" style="--diff-accent: #b22c2e;">
            <div class="diff-card__glow-border" aria-hidden="true"></div>
            <div class="diff-card__bg-gradient" aria-hidden="true"></div>
            <div class="diff-card__number" aria-hidden="true">03</div>
            <div class="diff-card__accent"></div>
            <h3 class="diff-card__title">We turn analysis into decisions</h3>
            <p class="diff-card__text">Technical depth means nothing if leadership can't act on it. We translate complexity into clear executive choices — fast.</p>
            <div class="diff-card__line" aria-hidden="true"></div>
          </article>
        </div>
      </div>
    </div>
  </section>

  <!-- ── 4. LIGHTSPEED WARP + CTA ── -->
  <!-- Warp zone: tall section with sticky viewport — gives scroll room for canvas warp animation -->
  <section id="lightspeedCta" class="lightspeed-warp">
    <div class="lightspeed-warp__sticky"></div>
  </section>

  <!-- CTA content: sticky so it stays centered while footer scrolls up beneath -->
  <div class="lightspeed-cta-wrapper">
    <section id="lightspeedContent" class="lightspeed-cta-content">
      <h2 class="text-4xl md:text-5xl lg:text-6xl text-[#14191c]">Bring us your toughest<br/>location decision.</h2>
      <p class="mx-auto mt-5 max-w-2xl text-lg text-[#14191c]/70">
        We will shape options, pressure-test assumptions, and build a strategy your leadership can stand behind.
      </p>
      <div class="mt-8 flex flex-wrap justify-center gap-3">
        <a class="btn-primary magnetic-btn" href={withBase("/contact")}>Talk to Vista</a>
        <a class="btn-secondary magnetic-btn lightspeed-btn-outline" href={withBase("/teams")}>Explore our teams</a>
      </div>
    </section>
  </div>
</Layout>

<script>
  import { initializeHomePageMotion } from "../scripts/homeMotion";

  let cleanupHomeMotion = null;

  const mountHomeMotion = () => {
    cleanupHomeMotion?.();
    cleanupHomeMotion = initializeHomePageMotion();
  };

  mountHomeMotion();
  document.addEventListener("astro:page-load", mountHomeMotion);
  document.addEventListener("astro:before-swap", () => {
    cleanupHomeMotion?.();
    cleanupHomeMotion = null;
  });
</script>

<script>
  // ── Counter animation ──
  const animateCounter = (el: HTMLElement) => {
    const target = parseInt(el.dataset.target || "0", 10);
    const prefix = el.dataset.prefix || "";
    const suffix = el.dataset.suffix || "";
    const duration = 1200;
    const start = performance.now();

    const tick = (now: number) => {
      const elapsed = now - start;
      const progress = Math.min(elapsed / duration, 1);
      // Ease-out cubic
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.round(eased * target);
      el.textContent = `${prefix}${current.toLocaleString()}${suffix}`;
      if (progress < 1) {
        requestAnimationFrame(tick);
      } else {
        // Counter finished — trigger glow animation on parent tile
        const tile = el.closest(".metric-tile");
        if (tile) tile.classList.add("is-counted");
      }
    };

    requestAnimationFrame(tick);
  };

  // ── IntersectionObserver for counters ──
  // (Timeline is now driven by GSAP ScrollTrigger in homeMotion.ts)
  const setupObservers = () => {
    const counterEls = document.querySelectorAll<HTMLElement>("[data-counter]");

    const counterObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          animateCounter(entry.target as HTMLElement);
          counterObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.5 });

    counterEls.forEach(el => counterObserver.observe(el));
  };

  setupObservers();
  document.addEventListener("astro:page-load", setupObservers);
</script>
