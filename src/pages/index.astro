---
import Layout from "../layouts/Layout.astro";
import { teamBuckets } from "../data/teams";

const base = import.meta.env.BASE_URL;
const baseWithSlash = base.endsWith("/") ? base : `${base}/`;
const withBase = (path) => `${baseWithSlash}${path.startsWith("/") ? path.slice(1) : path}`;

const heroSlides = [
  {
    title: "Decisions with weight.\nDelivery with speed.",
    isHero: true,
  },
  {
    title: "Signal in\nthe noise.",
  },
  {
    title: "Leverage in\nevery market.",
  },
  {
    title: "Execution that\nholds up.",
  },
];

const orbitNodeMap = [
  { slug: "economic-impact-studies",  id: "node-eis",         ring: 1 },
  { slug: "aerospace-defense",       id: "node-aerospace",   ring: 2 },
  { slug: "data-analytics",          id: "node-data",        ring: 2 },
  { slug: "data-centers",            id: "node-datacenters", ring: 2 },
  { slug: "incentives-compliance",   id: "node-incentives",  ring: 1 },
  { slug: "leadership",              id: "node-leadership",  ring: 1 },
];

const orbitNodes = orbitNodeMap.map(({ slug, id, ring }) => {
  const team = teamBuckets.find(t => t.slug === slug)!;
  return {
    id,
    ring,
    label: team.name,
    shortName: team.shortName,
    accent: team.accent,
    description: team.summary.split(".")[0] + ".",
    href: `/teams/${slug}`,
  };
}).concat([{
  id: "node-contact",
  ring: 3,
  label: "Start a Conversation",
  shortName: "COMMS",
  accent: "#b5d9ee",
  description: "Reach the Vista team directly.",
  href: "/contact",
}]);

const homeMotionConfig = {
  sequenceHeightDesktop: 620,
  sequenceHeightMobile: 560,
  animation: {
    revealDuration: 0.8,
    revealY: 24,
    magneticScale: 1.02
  },
  stars: {
    desktopCount: 920,
    mobileCount: 520,
    depth: 1600,
    baseSpeed: 0.28,
    warpBoost: 5.2
  },
  orbit: {
    start: 0.76,
    full: 0.93,
    radiusDesktop: 560,
    radiusMobile: 280,
    rings: [
      { radiusFactor: 0.45, ellipseRatio: 0.52, ellipseRatioMobile: 0.60, speedMultiplier: 1.4, tiltOffset: 0, strokeAlpha: 0.10 },
      { radiusFactor: 0.72, ellipseRatio: 0.58, ellipseRatioMobile: 0.66, speedMultiplier: 1.0, tiltOffset: 0.08, strokeAlpha: 0.14 },
      { radiusFactor: 1.0, ellipseRatio: 0.64, ellipseRatioMobile: 0.72, speedMultiplier: 0.7, tiltOffset: -0.06, strokeAlpha: 0.18 },
    ]
  }
};
---

<Layout
  title="Vista Site Selection | Reimagined"
  description="Responsive, motion-forward concept for Vista Site Selection featuring immersive storytelling and bucketed specialty teams."
>
  <section id="heroSequenceWrapper" class="hero-sequence-wrapper" data-motion-config={JSON.stringify(homeMotionConfig)} data-logo-src={withBase("/logos/vista-mark-white.png")} data-base-path={baseWithSlash.replace(/\/$/, "")}>
    <div class="hero-sequence-sticky">
      <canvas id="heroWaveCanvas" class="hero-wave-canvas" aria-hidden="true"></canvas>
      <div class="hero-noise-layer"></div>
      <div class="hero-scanline-layer" aria-hidden="true"></div>

      <div class="section-shell hero-overlay-grid hero-overlay-grid--solo">
        <div id="heroIntro" class="hero-stack">
          <span class="chip chip--ghost">Site Selection + Incentives + Analytics</span>

          <!-- Title fly-through zone — all 4 titles live here -->
          <div id="heroSlideTrack" class="hero-slide-track-inline">
            <div class="hero-slide-frame">
              {
                heroSlides.map((slide, index) => (
                  <article
                    class={`hero-slide ${index === 0 ? "is-active" : ""}`}
                    data-slide
                    data-hero={slide.isHero ? "true" : undefined}
                  >
                    <h2 class="hero-title">
                      {slide.title.split("\n").map((line, lineIndex, lines) => (
                        <>
                          {slide.isHero && lineIndex === 0 ? (
                            <Fragment>Decisions with <span class="text-[#ebaa1f]">weight</span>.</Fragment>
                          ) : slide.isHero && lineIndex === 1 ? (
                            <Fragment>Delivery with <span class="text-[#b5d9ee]">speed</span>.</Fragment>
                          ) : (
                            <Fragment>{line}</Fragment>
                          )}
                          {lineIndex < lines.length - 1 && <br />}
                        </>
                      ))}
                    </h2>
                  </article>
                ))
              }
            </div>
          </div>

          <p class="max-w-2xl text-lg text-white/80 md:text-xl">
            Vista helps organizations pick the right locations, secure stronger incentives, and move with confidence
            using data-backed strategy.
          </p>
          <div class="flex flex-wrap gap-3">
            <a class="btn-primary magnetic-btn" href={withBase("/contact")}>Start a conversation</a>
            <a class="btn-secondary magnetic-btn btn-explore" href={withBase("/teams")}>Explore team buckets</a>
            <button id="skipIntroBtn" class="btn-secondary hero-skip-btn btn-skip magnetic-btn" type="button">
              Skip to orbit menu
            </button>
          </div>
          <div class="hero-kicker-list">
            <span class="mono">Board-ready strategy</span>
            <span class="mono">Negotiation leverage</span>
            <span class="mono">Execution certainty</span>
          </div>
        </div>
      </div>

      <div id="heroScrollCue" class="scroll-down-indicator scroll-down-indicator--hero" aria-hidden="true">
        <span class="scroll-down-indicator__text">Scroll to explore</span>
        <svg class="scroll-down-indicator__chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>

      <div id="orbitMenu" class="orbit-menu" aria-hidden="true">
        <div class="orbit-core">
          <canvas id="orbitPlanetCanvas" class="orbit-planet-canvas" aria-hidden="true"></canvas>
        </div>
        {
          orbitNodes.map((node, index) => (
            <a
              id={node.id}
              href={withBase(node.href)}
              class="orbit-node"
              data-orbit-node
              data-orbit-index={index}
              data-ring={node.ring}
              data-accent={node.accent}
              data-desc={node.description}
              data-short={node.shortName}
              aria-label={node.label}
            >
              <span class="orbit-node__dot"></span>
              <span class="orbit-node__pulse"></span>
              <span class="orbit-node__name">{node.shortName}</span>
              <div class="orbit-node__popup">
                <span class="orbit-node__popup-corner"></span>
                <span class="orbit-node__label">{node.label}</span>
                <span class="orbit-node__desc">{node.description}</span>
              </div>
            </a>
          ))
        }
      </div>

      <div id="scrollDownIndicator" class="scroll-down-indicator" aria-hidden="true">
        <span class="scroll-down-indicator__text">Keep exploring</span>
        <svg class="scroll-down-indicator__chevron" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>

      <div id="mobilePopupOverlay" class="mobile-popup-overlay" aria-hidden="true">
        <div class="mobile-popup-overlay__card">
          <span class="mobile-popup-overlay__label"></span>
          <span class="mobile-popup-overlay__desc"></span>
          <span class="mobile-popup-overlay__cta">Tap again to visit &rarr;</span>
        </div>
      </div>
    </div>
  </section>

  <!-- ── 1. METRIC COUNTERS ── -->
  <section class="section-shell py-8">
    <div class="metric-grid">
      <article class="metric-tile" data-reveal>
        <p class="stat-number text-[#ebaa1f]" data-counter data-target="1000" data-suffix="+">0</p>
        <p class="mono text-sm text-white/75">PROJECTS SUPPORTED</p>
      </article>
      <article class="metric-tile" data-reveal>
        <p class="stat-number text-[#b5d9ee]" data-counter data-prefix="$" data-target="4" data-suffix="B+">0</p>
        <p class="mono text-sm text-white/75">INCENTIVES NEGOTIATED</p>
      </article>
      <article class="metric-tile" data-reveal>
        <p class="stat-number text-white" data-counter data-target="40" data-suffix="+">0</p>
        <p class="mono text-sm text-white/75">MARKETS ANALYZED YEARLY</p>
      </article>
      <article class="metric-tile" data-reveal>
        <p class="stat-number text-[#b22c2e]">24/7</p>
        <p class="mono text-sm text-white/75">EXECUTION MINDSET</p>
      </article>
    </div>
  </section>

  <!-- ── 2. PROCESS TIMELINE ── -->
  <section class="section-shell py-20">
    <div class="mb-10 flex flex-wrap items-end justify-between gap-4">
      <div class="space-y-2">
        <span class="chip">Client Workflow</span>
        <h2 data-reveal class="text-3xl md:text-4xl">How Vista runs engagements</h2>
      </div>
    </div>
    <div class="process-timeline" data-reveal>
      <div class="process-timeline__track">
        <div class="process-timeline__line">
          <div class="process-timeline__line-fill"></div>
        </div>
        <div class="process-timeline__step" data-step>
          <div class="process-timeline__dot"></div>
          <div class="process-timeline__content">
            <span class="process-timeline__num">01</span>
            <h3 class="process-timeline__title">Frame Decision</h3>
            <p class="process-timeline__desc">Lock the strategic criteria and business constraints.</p>
          </div>
        </div>
        <div class="process-timeline__step" data-step>
          <div class="process-timeline__dot"></div>
          <div class="process-timeline__content">
            <span class="process-timeline__num">02</span>
            <h3 class="process-timeline__title">Model Markets</h3>
            <p class="process-timeline__desc">Score labor, cost, risk, and operational fit.</p>
          </div>
        </div>
        <div class="process-timeline__step" data-step>
          <div class="process-timeline__dot"></div>
          <div class="process-timeline__content">
            <span class="process-timeline__num">03</span>
            <h3 class="process-timeline__title">Shape Incentives</h3>
            <p class="process-timeline__desc">Build and negotiate package structures with leverage.</p>
          </div>
        </div>
        <div class="process-timeline__step" data-step>
          <div class="process-timeline__dot"></div>
          <div class="process-timeline__content">
            <span class="process-timeline__num">04</span>
            <h3 class="process-timeline__title">Execute Confidently</h3>
            <p class="process-timeline__desc">Move from selection to launch with implementation rigor.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ── 3. DIFFERENTIATORS ── -->
  <section class="section-shell py-20">
    <div class="diff-section">
      <div class="diff-header" data-reveal>
        <span class="chip">The Vista Edge</span>
        <h2 class="mt-3 text-4xl md:text-5xl">Three reasons we<br/>don't lose.</h2>
      </div>
      <div class="diff-cards">
        <article class="diff-card" data-reveal>
          <div class="diff-card__number">01</div>
          <div class="diff-card__accent" style="--diff-accent: #ebaa1f;"></div>
          <h3 class="diff-card__title">We integrate from day one</h3>
          <p class="diff-card__text">Site strategy, incentives, and analytics operate as one team from the first call. No handoffs. No silos. One engine.</p>
        </article>
        <article class="diff-card" data-reveal>
          <div class="diff-card__number">02</div>
          <div class="diff-card__accent" style="--diff-accent: #b5d9ee;"></div>
          <h3 class="diff-card__title">We model downside early</h3>
          <p class="diff-card__text">Every recommendation is pressure-tested against labor risk, regulatory shifts, and governance alignment before it reaches your board.</p>
        </article>
        <article class="diff-card" data-reveal>
          <div class="diff-card__number">03</div>
          <div class="diff-card__accent" style="--diff-accent: #b22c2e;"></div>
          <h3 class="diff-card__title">We turn analysis into decisions</h3>
          <p class="diff-card__text">Technical depth means nothing if leadership can't act on it. We translate complexity into clear executive choices — fast.</p>
        </article>
      </div>
    </div>
  </section>

  <!-- ── 4. LIGHTSPEED CTA ── -->
  <!-- Section height gives scroll room for the warp animation on the fixed canvas -->
  <!-- Once canvas goes white, it hides and this white section shows through -->
  <section id="lightspeedCta" class="lightspeed-cta">
    <div class="lightspeed-cta__sticky">
      <div class="lightspeed-cta__content">
        <h2 class="text-4xl md:text-5xl lg:text-6xl text-[#14191c]">Bring us your toughest<br/>location decision.</h2>
        <p class="mx-auto mt-5 max-w-2xl text-lg text-[#14191c]/70">
          We will shape options, pressure-test assumptions, and build a strategy your leadership can stand behind.
        </p>
        <div class="mt-8 flex flex-wrap justify-center gap-3">
          <a class="btn-primary magnetic-btn" href={withBase("/contact")}>Talk to Vista</a>
          <a class="btn-secondary magnetic-btn lightspeed-btn-outline" href={withBase("/teams")}>Explore our teams</a>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  import { initializeHomePageMotion } from "../scripts/homeMotion";

  let cleanupHomeMotion = null;

  const mountHomeMotion = () => {
    cleanupHomeMotion?.();
    cleanupHomeMotion = initializeHomePageMotion();
  };

  mountHomeMotion();
  document.addEventListener("astro:page-load", mountHomeMotion);
  document.addEventListener("astro:before-swap", () => {
    cleanupHomeMotion?.();
    cleanupHomeMotion = null;
  });
</script>

<script>
  // ── Counter animation ──
  const animateCounter = (el: HTMLElement) => {
    const target = parseInt(el.dataset.target || "0", 10);
    const prefix = el.dataset.prefix || "";
    const suffix = el.dataset.suffix || "";
    const duration = 1200;
    const start = performance.now();

    const tick = (now: number) => {
      const elapsed = now - start;
      const progress = Math.min(elapsed / duration, 1);
      // Ease-out cubic
      const eased = 1 - Math.pow(1 - progress, 3);
      const current = Math.round(eased * target);
      el.textContent = `${prefix}${current.toLocaleString()}${suffix}`;
      if (progress < 1) requestAnimationFrame(tick);
    };

    requestAnimationFrame(tick);
  };

  // ── Timeline reveal ──
  const revealTimeline = (el: HTMLElement) => {
    el.classList.add("is-revealed");
  };

  // ── IntersectionObserver for counters + timeline ──
  const setupObservers = () => {
    const counterEls = document.querySelectorAll<HTMLElement>("[data-counter]");
    const timelineEl = document.querySelector<HTMLElement>(".process-timeline");

    const counterObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          animateCounter(entry.target as HTMLElement);
          counterObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.3 });

    counterEls.forEach(el => counterObserver.observe(el));

    if (timelineEl) {
      const timelineObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            revealTimeline(entry.target as HTMLElement);
            timelineObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.2 });

      timelineObserver.observe(timelineEl);
    }
  };

  setupObservers();
  document.addEventListener("astro:page-load", setupObservers);
</script>
